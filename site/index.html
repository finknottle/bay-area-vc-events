<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bay Area VC Events v2</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f9fafb; color: #111827; }
      .container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
      h1 { font-size: 1.875rem; font-weight: 800; margin: 0 0 0.25rem; }
      .muted { color: #6b7280; font-size: 0.9rem; }
      .topbar { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; justify-content: space-between; margin: 1.25rem 0; }
      input { padding: 0.75rem 1rem; width: min(420px, 100%); border: 1px solid #d1d5db; border-radius: 0.75rem; box-sizing: border-box; font-size: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
      select { padding: 0.65rem 0.8rem; border: 1px solid #d1d5db; border-radius: 0.75rem; background: white; font-size: 0.95rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
      .check { display:flex; align-items:center; gap:0.4rem; font-size:0.92rem; color:#374151; user-select:none; }
      .check input { width:auto; box-shadow:none; }
      .counts { font-size: 0.85rem; color: #6b7280; }

      .event-card { background: white; padding: 1.1rem 1.15rem; border-radius: 0.85rem; margin-bottom: 0.9rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
      .event-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.75rem; }
      .event-source { font-weight: 700; color: #4f46e5; text-transform: uppercase; font-size: 0.72rem; letter-spacing: 0.06em; }
      .event-title { font-size: 1.125rem; font-weight: 800; line-height: 1.35; margin: 0.25rem 0 0.2rem; }
      .event-title a { color: #111827; text-decoration: none; border-bottom: 2px solid transparent; }
      .event-title a:hover { border-bottom-color: #4f46e5; }
      .event-title .clamp { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

      .meta-row { display: flex; flex-wrap: wrap; gap: 0.55rem 1rem; margin-top: 0.65rem; font-size: 0.92rem; color: #374151; }
      .meta-item { display: flex; align-items: baseline; gap: 0.35rem; }
      .meta-label { font-weight: 700; color: #111827; }

      .badge { padding: 0.25rem 0.55rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 650; background: #f3f4f6; color: #374151; white-space: nowrap; }
      .badge-price { background: #dcfce7; color: #166534; }
      .badge-city { background: #e0e7ff; color: #3730a3; }

      .day-header { margin: 1.25rem 0 0.6rem; font-size: 0.95rem; font-weight: 800; color: #111827; }
      .day-sub { font-weight: 600; color: #6b7280; margin-left: 0.35rem; }

      details { background: transparent; border: none; }
      details > summary { cursor: pointer; color: #4f46e5; font-weight: 700; margin: 1.0rem 0 0.5rem; }

      .footer { margin-top: 2rem; color: #6b7280; font-size: 0.85rem; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Bay Area VC Events</h1>
      <div class="muted">Upcoming events • grouped by day • click any title to RSVP.</div>

      <div class="topbar">
        <input id="q" placeholder="Search: AI, demo day, Palo Alto, YC, pitch..." />

        <div style="display:flex; gap:0.65rem; flex-wrap:wrap; align-items:center; justify-content:flex-end;">
          <select id="city">
            <option value="">All cities</option>
          </select>

          <select id="range">
            <option value="all">Any time</option>
            <option value="7">Next 7 days</option>
            <option value="30">Next 30 days</option>
          </select>

          <label class="check">
            <input id="free" type="checkbox" />
            Free only
          </label>

          <div class="counts" id="counts"></div>
        </div>
      </div>

      <div id="list"></div>

      <div class="footer">
        Tip: if an event is missing a date, it’s being scraped from a non-structured page. We’ll keep improving source-specific parsing.
      </div>
    </div>

    <script>
      async function load() {
        const res = await fetch(`./events.json?t=${Date.now()}`, { cache: 'no-store' });
        const data = await res.json();
        return data.events || [];
      }

      function inferCity(location) {
        const l = (location || '').toLowerCase();
        if (!l) return null;
        if (l.includes('san francisco') || l.includes(' sf')) return 'San Francisco';
        if (l.includes('palo alto')) return 'Palo Alto';
        if (l.includes('mountain view')) return 'Mountain View';
        if (l.includes('menlo park')) return 'Menlo Park';
        if (l.includes('redwood city')) return 'Redwood City';
        if (l.includes('sunnyvale')) return 'Sunnyvale';
        if (l.includes('san jose')) return 'San Jose';
        if (l.includes('oakland')) return 'Oakland';
        if (l.includes('berkeley')) return 'Berkeley';
        return null;
      }

      function escapeHtml(s) {
        return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      }

      function looksLikeFree(price) {
        const p = (price || '').toString().toLowerCase().trim();
        if (!p) return false;
        return p === 'free' || p.includes('free') || p.includes('$0') || p.includes('no cost');
      }

      function formatWhen(e) {
        if (!e.start) return { dateStr: null, timeStr: null, dayKey: null };
        const start = new Date(e.start);
        if (Number.isNaN(start.getTime())) return { dateStr: null, timeStr: null, dayKey: null };

        const dayKey = start.toISOString().slice(0, 10);
        const dateStr = start.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        const timeStr = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

        // Optional end time
        let range = timeStr;
        if (e.end) {
          const end = new Date(e.end);
          if (!Number.isNaN(end.getTime())) {
            const endStr = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            range = `${timeStr}–${endStr}`;
          }
        }

        return { dateStr, timeStr: range, dayKey };
      }

      function render(events, state) {
        const list = document.getElementById('list');
        const counts = document.getElementById('counts');
        list.innerHTML = '';

        const query = (state?.q || '').toLowerCase().trim();
        const cityFilter = (state?.city || '').trim();
        const freeOnly = !!state?.free;
        const rangeDays = state?.rangeDays || null;

        const now = new Date();
        const rangeEnd = rangeDays ? new Date(now.getTime() + rangeDays * 24 * 60 * 60 * 1000) : null;

        const matchesQuery = (e) => {
          if (!query) return true;
          const searchStr = `${e.title} ${e.source_name} ${e.location} ${e.rsvp_url} ${e.source_url}`.toLowerCase();
          return searchStr.includes(query);
        };

        const matchesCity = (e) => {
          if (!cityFilter) return true;
          const c = e.city || inferCity(e.location) || 'Bay Area';
          return c === cityFilter;
        };

        const matchesFree = (e) => {
          if (!freeOnly) return true;
          return looksLikeFree(e.price);
        };

        const withDates = [];
        const tbdDates = [];

        for (const e of (events || [])) {
          if (!matchesQuery(e) || !matchesCity(e) || !matchesFree(e)) continue;

          const hasStart = !!e.start && !Number.isNaN(new Date(e.start).getTime());
          if (hasStart) {
            const d = new Date(e.start);
            if (d < now) continue;
            if (rangeEnd && d > rangeEnd) continue;
            withDates.push(e);
          } else {
            tbdDates.push(e);
          }
        }

        withDates.sort((a, b) => new Date(a.start) - new Date(b.start));

        const upcomingCount = withDates.length;
        const tbdCount = tbdDates.length;
        counts.textContent = `${upcomingCount} upcoming${tbdCount ? ` • ${tbdCount} date TBD` : ''}`;

        if (!upcomingCount && !tbdCount) {
          list.innerHTML = '<div class="muted">No events match your filters.</div>';
          return;
        }

        // Group upcoming by day
        let currentDay = null;
        for (const e of withDates) {
          const { dateStr, timeStr, dayKey } = formatWhen(e);
          if (dayKey && dayKey !== currentDay) {
            currentDay = dayKey;
            const h = document.createElement('div');
            h.className = 'day-header';
            h.textContent = dateStr;
            list.appendChild(h);
          }

          const card = document.createElement('div');
          card.className = 'event-card';

          const city = e.city || inferCity(e.location) || 'Bay Area';
          const price = (e.price && String(e.price).trim()) ? e.price : (looksLikeFree(e.price) ? 'Free' : 'TBA');
          const rsvpUrl = e.rsvp_url || e.source_url;

          const title = escapeHtml(e.title || '(Untitled event)');
          const source = escapeHtml(e.source_name || 'Source');
          const location = (e.location && String(e.location).trim()) ? escapeHtml(e.location) : null;

          card.innerHTML = `
            <div class="event-header">
              <div>
                <div class="event-source">${source}</div>
                <div class="event-title"><a href="${escapeHtml(rsvpUrl)}" target="_blank" rel="noreferrer"><span class="clamp">${title}</span></a></div>
              </div>
              <div style="display:flex; gap:0.5rem; align-items:flex-start; flex-wrap:wrap; justify-content:flex-end;">
                <span class="badge badge-city">${escapeHtml(city)}</span>
                <span class="badge badge-price">${escapeHtml(price)}</span>
              </div>
            </div>
            <div class="meta-row">
              <div class="meta-item"><span class="meta-label">When:</span> <span>${escapeHtml(timeStr || 'TBA')}</span></div>
              ${location ? `<div class="meta-item"><span class="meta-label">Where:</span> <span>${location}</span></div>` : ''}
              <div class="meta-item"><a href="${escapeHtml(rsvpUrl)}" target="_blank" rel="noreferrer">Open RSVP / details</a></div>
            </div>
          `;

          list.appendChild(card);
        }

        // Show "date TBD" items in a collapsible section
        if (tbdDates.length) {
          const details = document.createElement('details');
          const summary = document.createElement('summary');
          summary.textContent = `Date TBD (${tbdDates.length})`;
          details.appendChild(summary);

          const wrap = document.createElement('div');

          // Keep these in a stable order (source, then title)
          tbdDates.sort((a, b) => `${a.source_name || ''} ${a.title || ''}`.localeCompare(`${b.source_name || ''} ${b.title || ''}`));

          for (const e of tbdDates.slice(0, 80)) {
            const card = document.createElement('div');
            card.className = 'event-card';

            const city = e.city || inferCity(e.location) || 'Bay Area';
            const price = (e.price && String(e.price).trim()) ? e.price : (looksLikeFree(e.price) ? 'Free' : 'TBA');
            const rsvpUrl = e.rsvp_url || e.source_url;

            const title = escapeHtml(e.title || '(Untitled event)');
            const source = escapeHtml(e.source_name || 'Source');
            const location = (e.location && String(e.location).trim()) ? escapeHtml(e.location) : null;

            card.innerHTML = `
              <div class="event-header">
                <div>
                  <div class="event-source">${source}</div>
                  <div class="event-title"><a href="${escapeHtml(rsvpUrl)}" target="_blank" rel="noreferrer"><span class="clamp">${title}</span></a></div>
                </div>
                <div style="display:flex; gap:0.5rem; align-items:flex-start; flex-wrap:wrap; justify-content:flex-end;">
                  <span class="badge badge-city">${escapeHtml(city)}</span>
                  <span class="badge badge-price">${escapeHtml(price)}</span>
                </div>
              </div>
              <div class="meta-row">
                <div class="meta-item"><span class="meta-label">When:</span> <span>TBD</span></div>
                ${location ? `<div class="meta-item"><span class="meta-label">Where:</span> <span>${location}</span></div>` : ''}
                <div class="meta-item"><a href="${escapeHtml(rsvpUrl)}" target="_blank" rel="noreferrer">Open source page</a></div>
              </div>
            `;

            wrap.appendChild(card);
          }

          if (tbdDates.length > 80) {
            const note = document.createElement('div');
            note.className = 'muted';
            note.textContent = `Showing 80 of ${tbdDates.length} date-TBD items (refine your search to narrow).`;
            wrap.appendChild(note);
          }

          details.appendChild(wrap);
          list.appendChild(details);
        }
      }

      function getCityLabel(e) {
        return e.city || inferCity(e.location) || 'Bay Area';
      }

      function buildCityOptions(events) {
        const el = document.getElementById('city');
        const cities = Array.from(new Set((events || []).map(getCityLabel))).sort((a, b) => a.localeCompare(b));

        // Reset to default option
        el.innerHTML = '<option value="">All cities</option>';
        for (const c of cities) {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          el.appendChild(opt);
        }
      }

      function readState() {
        const q = document.getElementById('q').value || '';
        const city = document.getElementById('city').value || '';
        const free = document.getElementById('free').checked;
        const rangeRaw = document.getElementById('range').value;
        const rangeDays = rangeRaw === 'all' ? null : Number(rangeRaw);
        return { q, city, free, rangeDays };
      }

      (async function() {
        const events = await load();

        buildCityOptions(events);

        const q = document.getElementById('q');
        const city = document.getElementById('city');
        const free = document.getElementById('free');
        const range = document.getElementById('range');

        const rerender = () => render(events, readState());

        rerender();
        q.addEventListener('input', rerender);
        city.addEventListener('change', rerender);
        free.addEventListener('change', rerender);
        range.addEventListener('change', rerender);
      })();
    </script>
  </body>
</html>
